<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4H6J1SCJ52"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-4H6J1SCJ52");
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <title id="pageTitle">Enquire Form - Pilates with Filomena</title>
    <style>
      body {
        margin: 0;
        font-family: "Inter", sans-serif; /* Using a common system font */
        background-color: #f4f7f6;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
        box-sizing: border-box; /* Include padding in element's total width and height */
      }

      /* Container for the form */
      .form-container {
        background-color: #ffffff;
        padding: 32px; /* p-8 */
        border-radius: 8px; /* rounded-lg */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
        width: 100%;
        max-width: 384px; /* max-w-sm */
      }

      /* Form Title */
      .form-title {
        font-size: 24px; /* text-2xl */
        font-weight: bold; /* font-bold */
        margin-bottom: 8px; /* Reduced margin to make space for the new text */
        text-align: center; /* text-center */
        color: black;
      }

      /* Text below the title */
      .subtitle-text {
        font-size: 14px; /* Smaller font size */
        text-align: left; /* Changed to left alignment */
        color: black;
        margin-bottom: 24px; /* Add space below the subtitle */
      }

      .footer-text {
        font-size: 14px; /* Smaller font size */
        text-align: left; /* Changed to left alignment */
        color: #555; /* Slightly muted color */
        margin-top: 24px; /* Add space below the subtitle */
      }

      /* Form Group (Label + Input/Select) */
      .form-group {
        margin-bottom: 16px; /* Consistent margin-bottom */
      }

      .failed-submission {
        color: red;
      }

      .success-submission {
        color: green;
      }

      /* Label Styling */
      .form-group label {
        display: block; /* block */
        color: black;
        font-size: 14px; /* text-sm */
        font-weight: 600; /* font-semibold */
        margin-bottom: 8px; /* mb-2 */
      }

      /* Add a red asterisk after the label of required fields */
      .form-group label[for="name"]::after,
      .form-group label[for="email"]::after,
      .form-group label[for="location"]::after,
      .form-group label[for="numPeople"]::after, /* Added for numPeople field */
      .form-group label[for="submissionDate"]::after {
        content: " *"; /* Add asterisk content */
        color: #ef4444; /* Red color for the asterisk */
        margin-left: 4px; /* Add a small space between the label and asterisk */
      }

      /* Input and Select Styling */
      .form-group textarea,
      .form-group input[type="email"],
      .form-group input[type="text"],
      .form-group input[type="number"], /* Added for number input type */
      .form-group input[type="datetime-local"],
      .form-group select {
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* shadow */
        appearance: none; /* Attempts to reset default browser appearance */
        border: 1px solid #d1d5db; /* border */
        border-radius: 4px; /* rounded */
        width: 100%; /* Make them fill the container */
        padding: 8px 12px; /* py-2 px-3 */
        color: black;
        line-height: 1.5; /* leading-tight */
        outline: none; /* focus:outline-none */
        box-sizing: border-box; /* Include padding and border in the element's total width */
        display: block; /* Ensure they behave as block elements */
        background-color: #fff; /* Ensure consistent background for select */
        cursor: pointer; /* Indicate it's selectable */
      }

      /* Focus states for Input and Select */
      .form-group textarea:focus,
      .form-group input[type="email"]:focus,
      .form-group input[type="text"]:focus,
      .form-group input[type="number"]:focus, /* Added for number input type */
      .form-group input[type="datetime-local"]:focus,
      .form-group select:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* focus:shadow-outline (approximated) */
        border-color: #3b82f6; /* focus:border-blue-500 (approximated) */
      }

      /* Submit Button Container */
      .button-container {
        display: flex; /* flex */
        align-items: center; /* items-center */
        justify-content: center; /* justify-center */
        margin-top: 24px; /* Add some space above the button */
        margin-bottom: 24px; /* Add space below the button before the conditions */
      }

      /* Submit Button Styling */
      .submit-button {
        background-color: #3b82f6; /* bg-blue-500 */
        color: white; /* text-white */
        font-weight: bold; /* font-bold */
        padding: 8px 16px; /* py-2 px-4 */
        border-radius: 4px; /* rounded */
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out; /* Add a subtle transition */
      }

      /* Submit Button Hover State */
      .submit-button:hover {
        background-color: #2563eb; /* hover:bg-blue-700 */
      }

      /* Submit Button Focus State */
      .submit-button:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* focus:shadow-outline (approximated) */
      }

      /* Success Message Overlay */
      .success-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .success-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .success-message {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        color: #1f2937;
        max-width: 300px;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
      }

      .success-overlay.show .success-message {
        transform: translateY(0);
      }
    </style>
  </head>
  <body>
    <div class="form-container">
      <h2 class="form-title" id="formTitle">Enquire Form</h2>
      <p class="subtitle-text" id="formSubtitle">Please fill in the form below to send your enquiry.</p>

      <form id="submissionForm" method="POST">
        <input type="hidden" name="access_key" value="b04b2954-404f-407b-8fd4-b6d83bb16a3b" />
        <input type="checkbox" name="botcheck" class="hidden" style="display: none" />

        <div class="form-group">
          <label for="packSelection">Enquire about:</label>
          <select id="packSelection"></select>
        </div>

        <div class="form-group">
          <label for="name">Name:</label> <input type="text" id="name" name="name" required />
        </div>

        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" name="email" required />
        </div>

        <div class="form-group" id="locationGroup">
          <label for="location">Location:</label>
          <input type="text" id="location" name="location" required />
        </div>

        <div class="form-group" id="numPeopleGroup" style="display: none">
          <label for="numPeople">Number of people:</label>
          <input type="number" id="numPeople" name="numPeople" min="1" max="8" required />
        </div>

        <div class="form-group">
          <label for="submissionDate" id="submissionDateLabel">Preferred start date:</label>
          <input type="datetime-local" id="submissionDate" name="submissionDate" required />
        </div>

        <div class="form-group">
          <label for="comments">Message:</label>
          <textarea rows="2" id="comments" name="comments" placeholder="Any additional details?"></textarea>
        </div>

        <div class="button-container">
          <button type="submit" class="submit-button" id="submitButton">Submit Enquiry</button>
        </div>
      </form>
      <div class="footer-text" id="footerText">
        On submission, this form will send an email to
        <a href="mailto:info@pilateswithfilomena.com">info@pilateswithfilomena.com</a>
        with your query.
      </div>
    </div>

    <div id="successOverlay" class="success-overlay">
      <div class="success-message">Thank you for your enquiry! We will get back to you shortly.</div>
    </div>

    <script>
      // Define form options
      const options = {
        "1-private-class": {
          title: "1 Private Class",
          showCount: false,
          dateLabel: "Preferred start date:",
          showLocation: true,
        },
        "8-private-classes": {
          title: "8 Private Classes Pack",
          showCount: false,
          dateLabel: "Preferred start date:",
          showLocation: true,
        },
        "12-private-classes": {
          title: "12 Private Classes Pack",
          showCount: false,
          dateLabel: "Preferred start date:",
          showLocation: true,
        },
        "1-private-group-class": {
          title: "1 Private Group Class",
          showCount: true,
          dateLabel: "Preferred start date:",
          showLocation: true,
        },
        "8-private-group-classes": {
          title: "8 Private Group Classes Pack",
          showCount: true,
          dateLabel: "Preferred start date:",
          showLocation: true,
        },
        "12-private-group-classes": {
          title: "12 Private Group Classes Pack",
          showCount: true,
          dateLabel: "Preferred start date:",
          showLocation: true,
        },
        "dentist-1-private-session": {
          title: "1 Private Session (Dentists)",
          showCount: false,
          dateLabel: "Preferred start date:",
          showLocation: true,
        },
        "dentist-8-private-session": {
          title: "8 Private Sessions Pack (Dentists)",
          showCount: false,
          dateLabel: "Preferred start date:",
          showLocation: true,
        },
        "dentist-12-private-session": {
          title: "12 Private Sessions Pack (Dentists)",
          showCount: false,
          dateLabel: "Preferred start date:",
          showLocation: true,
        },
        "dentist-12-team-session": {
          title: "12 Team Sessions Pack (Dentists)",
          showCount: true,
          dateLabel: "Preferred start date:",
          showLocation: true,
        },
        "intro-call": {
          title: "15 Minutes Intro Call (Dentists)",
          showCount: false,
          dateLabel: "Preferred call date/time:",
          showLocation: false,
        },
        "posture-pro-program": {
          title: "PosturePro Program",
          showCount: false,
          dateLabel: "Preferred start date:",
          showLocation: true,
        },
      };

      let currentOptionId = "1-private-class"; // Default option

      // Function to parse URL parameters using URLSearchParams
      function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Function to format date asYYYY-MM-DD
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0"); // Months are 0-indexed
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // Function to set the minimum date for the datetime-local input
      function setMinDateForInput() {
        const submissionDateInput = document.getElementById("submissionDate");
        const date = new Date();

        // any date in the future
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, "0"); // Month is 0-indexed
        const day = date.getDate().toString().padStart(2, "0");
        const hours = date.getHours().toString().padStart(2, "0");
        const minutes = date.getMinutes().toString().padStart(2, "0");

        const min = `${year}-${month}-${day}T${hours}:${minutes}`;
        submissionDateInput.min = min;
      }

      // Function to populate the option selection dropdown
      function populateOptionSelectionDropdown() {
        const optionSelect = document.getElementById("packSelection");
        optionSelect.innerHTML = ""; // Clear existing options

        for (const optionId in options) {
          const option = document.createElement("option");
          option.value = optionId;
          option.textContent = options[optionId].title;
          optionSelect.appendChild(option);
        }

        // Set the default selected option based on currentOptionId
        optionSelect.value = currentOptionId;
      }

      // Function to render the form content based on the selected option
      function renderOptionContent(optionId) {
        const optionData = options[optionId];
        if (!optionData) {
          console.error("Option not found:", optionId);
          return;
        }

        // Get the number of people group and input
        const numPeopleGroup = document.getElementById("numPeopleGroup");
        const numPeopleInput = document.getElementById("numPeople");
        const locationGroup = document.getElementById("locationGroup"); // Get location group
        const locationInput = document.getElementById("location"); // Get location input

        // Update page title
        document.getElementById("pageTitle").textContent = `Enquire Form - Pilates with Filomena`;
        // Update form title
        document.getElementById("formTitle").textContent = `Enquire Form`;
        // Subtitle is hardcoded in HTML, no need to update via JS

        // Update "Preferred start date" label using optionData.dateLabel
        document.getElementById("submissionDateLabel").textContent = optionData.dateLabel;

        // Update submit button text
        document.getElementById("submitButton").textContent = `Submit Enquiry`;

        // Show/hide "Number of people" field based on selected option's showCount property
        if (optionData.showCount) {
          numPeopleGroup.style.display = "block";
          numPeopleInput.setAttribute("required", "true");
        } else {
          numPeopleGroup.style.display = "none";
          numPeopleInput.removeAttribute("required");
          numPeopleInput.value = ""; // Clear value when hidden
        }

        // Show/hide "Location" field based on selected option's showLocation property
        if (optionData.showLocation) {
          locationGroup.style.display = "block";
          locationInput.setAttribute("required", "true");
        } else {
          locationGroup.style.display = "none";
          locationInput.removeAttribute("required");
          locationInput.value = ""; // Clear value when hidden
        }

        currentOptionId = optionId;
        // Ensure the dropdown reflects the currently rendered option
        document.getElementById("packSelection").value = currentOptionId;

        // Set min date for the datetime-local input
        setMinDateForInput();
      }

      // Function to show the success message and then redirect
      function showSuccessMessageAndRedirect() {
        const successOverlay = document.getElementById("successOverlay");
        successOverlay.classList.add("show");
        setTimeout(() => {
          successOverlay.classList.remove("show");
          window.location.href = "index.html"; // Redirect after message disappears
        }, 3000); // Show for 3 seconds, then redirect
      }

      // Event listener for option selection change
      document.getElementById("packSelection").addEventListener("change", function () {
        renderOptionContent(this.value);
      });

      // Handle form submission
      const form = document.getElementById("submissionForm");
      form.addEventListener("submit", async function (event) {
        // Always prevent default submission to handle redirection via JavaScript
        event.preventDefault();

        const footer = document.getElementById("footerText");
        const nameInput = document.getElementById("name");
        const emailInput = document.getElementById("email");
        const locationInput = document.getElementById("location");
        const numPeopleInput = document.getElementById("numPeople");
        const submissionDateInput = document.getElementById("submissionDate");

        const name = nameInput.value;
        const email = emailInput.value;
        const location = locationInput.value;
        const numPeople = numPeopleInput.value;
        const submissionDateTimeValue = submissionDateInput.value; // in local timezone

        // Clear any previous custom validity messages
        submissionDateInput.setCustomValidity("");

        let isValid = true; // Flag to track overall form validity

        // Validate name field
        if (!nameInput.checkValidity()) {
          isValid = false;
        }

        // Validate email
        if (!emailInput.checkValidity()) {
          isValid = false;
        }

        // Validate location field (only if visible/required)
        if (options[currentOptionId].showLocation && !locationInput.checkValidity()) {
          isValid = false;
        }

        // Validate number of people field (only if visible/required)
        if (options[currentOptionId].showCount && !numPeopleInput.checkValidity()) {
          isValid = false;
        }

        // Validate submission date
        if (submissionDateTimeValue === "") {
          isValid = false; // Mark as invalid if date is not selected
        }

        // If any validation failed, report validity and stop
        if (!isValid) {
          // This will trigger native validation messages for all invalid fields
          nameInput.reportValidity();
          emailInput.reportValidity();
          if (options[currentOptionId].showLocation) {
            // Only report if visible
            locationInput.reportValidity();
          }
          if (options[currentOptionId].showCount) {
            // Only report if visible
            numPeopleInput.reportValidity();
          }
          submissionDateInput.reportValidity();
          return;
        }

        // If all validations pass, proceed with submission
        const formData = new FormData(form);
        const object = {
          ...Object.fromEntries(formData),
          from_name: "Form Notifier - Pilates with Filomena",
          subject: `${name} - ${options[currentOptionId].title}`,
        };
        const json = JSON.stringify(object, (key, value) => {
          if (value === "") {
            return undefined;
          }
          return value;
        });

        function fallbackOnError(error) {
          const payload = Object.entries(object)
            .map(([key, value]) => {
              if (key === "access_key" || key === "from_name") {
                return undefined;
              }
              if (value === null || value === undefined || value === "") {
                return undefined;
              }
              return `${key}: ${String(value)}`;
            })
            .filter((entry) => entry !== undefined)
            .join("\n");
          console.log(payload);

          const targetEmail = "info@pilateswithfilomena.com";
          const subject = encodeURIComponent(object.subject);
          const body = encodeURIComponent(
            `Hi Filomena,

The enquiry form submission failed with "${error}", so here are my details:
${payload}

Kind regards,
${name}
`
          );

          const emailLink = `<a href="mailto:${targetEmail}?subject=${subject}&body=${body}">click here</a>`;

          footer.innerHTML = `Oops! Something failed: "${error}".<br/>Please try again or ${emailLink} to send the email manually.`;
          footer.classList.add("failed-submission");
        }

        try {
          footer.innerHTML = "Submitting... please wait.";
          const response = await fetch("https://api.web3forms.com/submit", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: json,
          });

          let responseJson = await response.json();
          console.log(response);
          console.log(responseJson);
          if (response.status == 200) {
            footer.innerHTML = "Email sent successfully. Thank you!";
            footer.classList.add("success-submission");
            showSuccessMessageAndRedirect();
          } else {
            fallbackOnError(responseJson.message);
          }
        } catch (error) {
          console.error("Error submitting form:", error);
          fallbackOnError(error);
        }
      });

      // Event listener for date input change to provide immediate feedback
      document.getElementById("submissionDate").addEventListener("change", function () {
        const submissionDateInput = this;
        // Always clear previous custom validity first
        submissionDateInput.setCustomValidity("");
        // reportValidity will show the message if invalid, or clear it if valid
        submissionDateInput.reportValidity();
      });

      // Initialize the page on load
      window.addEventListener("load", function () {
        // Check for URL parameter first
        const urlOption = getUrlParameter("option");
        if (urlOption && options[urlOption]) {
          currentOptionId = urlOption;
        }

        populateOptionSelectionDropdown();
        renderOptionContent(currentOptionId); // This will correctly show/hide numPeopleGroup and locationGroup on load
      });
    </script>
  </body>
</html>
