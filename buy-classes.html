<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <title id="pageTitle">Buy Welcome Pack - Pilates with Filomena</title>
    <style>
      /* Basic Reset and Body Styling */
      body {
        margin: 0;
        font-family: "Inter", sans-serif; /* Using a common system font */
        background-color: #f4f7f6;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
        box-sizing: border-box; /* Include padding in element's total width and height */
      }

      /* Container for the form */
      .form-container {
        background-color: #ffffff;
        padding: 32px; /* p-8 */
        border-radius: 8px; /* rounded-lg */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
        width: 100%;
        max-width: 384px; /* max-w-sm */
      }

      /* Form Title */
      .form-title {
        font-size: 24px; /* text-2xl */
        font-weight: bold; /* font-bold */
        margin-bottom: 8px; /* Reduced margin to make space for the new text */
        text-align: center; /* text-center */
        color: #1f2937; /* text-gray-800 */
      }

      /* Text below the title */
      .subtitle-text {
        font-size: 14px; /* Smaller font size */
        text-align: left; /* Changed to left alignment */
        color: #555; /* Slightly muted color */
        margin-bottom: 24px; /* Add space below the subtitle */
      }

      /* Form Group (Label + Input/Select) */
      .form-group {
        margin-bottom: 16px; /* Consistent margin-bottom */
      }

      /* Label Styling */
      .form-group label {
        display: block; /* block */
        color: #374151; /* text-gray-700 */
        font-size: 14px; /* text-sm */
        font-weight: 600; /* font-semibold */
        margin-bottom: 8px; /* mb-2 */
      }

      /* Add a red asterisk after the label of required fields */
      .form-group label[for="name"]::after, /* Added for name field */
      .form-group label[for="email"]::after,
      .form-group label[for="submissionDate"]::after {
        content: " *"; /* Add asterisk content */
        color: #ef4444; /* Red color for the asterisk */
        margin-left: 4px; /* Add a small space between the label and asterisk */
      }

      /* Input and Select Styling */
      .form-group input[type="email"],
      .form-group input[type="text"], /* Added for text input type */
      .form-group select {
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* shadow */
        appearance: none; /* Attempts to reset default browser appearance */
        border: 1px solid #d1d5db; /* border */
        border-radius: 4px; /* rounded */
        width: 100%; /* Make them fill the container */
        padding: 8px 12px; /* py-2 px-3 */
        color: #374151; /* text-gray-700 */
        line-height: 1.5; /* leading-tight */
        outline: none; /* focus:outline-none */
        box-sizing: border-box; /* Include padding and border in the element's total width */
        display: block; /* Ensure they behave as block elements */
        background-color: #fff; /* Ensure consistent background for select */
        cursor: pointer; /* Indicate it's selectable */
      }

      /* Focus states for Input and Select */
      .form-group input[type="email"]:focus,
      .form-group input[type="text"]:focus, /* Added for text input type */
      .form-group select:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* focus:shadow-outline (approximated) */
        border-color: #3b82f6; /* focus:border-blue-500 (approximated) */
      }

      /* Submit Button Container */
      .button-container {
        display: flex; /* flex */
        align-items: center; /* items-center */
        justify-content: center; /* justify-center */
        margin-top: 24px; /* Add some space above the button */
        margin-bottom: 24px; /* Add space below the button before the conditions */
      }

      /* Submit Button Styling */
      .submit-button {
        background-color: #3b82f6; /* bg-blue-500 */
        color: white; /* text-white */
        font-weight: bold; /* font-bold */
        padding: 8px 16px; /* py-2 px-4 */
        border-radius: 4px; /* rounded */
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out; /* Add a subtle transition */
      }

      /* Submit Button Hover State */
      .submit-button:hover {
        background-color: #2563eb; /* hover:bg-blue-700 */
      }

      /* Submit Button Focus State */
      .submit-button:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* focus:shadow-outline (approximated) */
      }

      /* Conditions List Styling */
      .conditions-list {
        background-color: #e0f2f7; /* A light blue background color */
        padding: 16px; /* Add some padding inside the box */
        border-radius: 8px; /* Match container border-radius */
        font-size: 12px; /* Smaller font size for conditions */
        color: #0f3a4c; /* Darker text color for readability */
      }

      .conditions-list ul {
        list-style: disc; /* Use bullet points */
        margin: 0;
        padding-left: 20px; /* Indent list items */
      }

      .conditions-list li {
        margin-bottom: 8px; /* Space between list items */
        line-height: 1.4; /* Improve readability */
      }

      .conditions-list li:last-child {
        margin-bottom: 0; /* No bottom margin for the last item */
      }

      .conditions-list h3 {
        font-size: 14px; /* Slightly larger font for the heading */
        font-weight: bold;
        margin-top: 0;
        margin-bottom: 10px; /* Space below the heading */
        color: #1f2937; /* Darker color for the heading */
      }
    </style>
  </head>
  <body>
    <div class="form-container">
      <h2 class="form-title" id="formTitle">Buy Welcome Pack</h2>
      <p class="subtitle-text" id="formSubtitle">
        Please fill in the form below and review the conditions at the bottom.
      </p>

      <form id="submissionForm" method="GET">
        <div class="form-group">
          <label for="packSelection">Selected Option:</label>
          <select id="packSelection"></select>
        </div>

        <div class="form-group">
          <label for="name">Name:</label> <input type="text" id="name" name="name" required />
        </div>

        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" name="email" required />
        </div>

        <div class="form-group">
          <label for="submissionDate" id="submissionDateLabel">Date of first class:</label>
          <select id="submissionDate" required>
            <option value="" disabled selected>Select a date</option>
          </select>
        </div>

        <div class="button-container">
          <button type="submit" class="submit-button" id="submitButton">Submit Form</button>
        </div>
      </form>

      <div class="conditions-list">
        <h3 id="termsHeading">Terms for Welcome Pack:</h3>
        <ul id="termsList"></ul>
      </div>
    </div>

    <script>
      // Define common unavailable date ranges at the top
      const UNAVAILABLE_DATE_RANGES = [
        // Example: specific dates to skip (YYYY-MM-DD)
        { start: "2025-06-07" }, // June 7, 2025 (Saturday)
        { start: "2025-06-14" }, // June 14, 2025 (Saturday)
        // // Example: a range of dates to skip (YYYY-MM-DD)
        // { start: "2025-06-01", end: "2025-06-17" }, // July 1st to July 7th, 2025
        // Add more global unavailable dates here
      ];

      // Define pack data
      const packs = {
        "welcome-pack": {
          title: "Welcome Pack",
          subtitle:
            "Please fill in the form below and review the conditions at the bottom, before proceeding to payment.",
          termsHeading: "Welcome Pack - Conditions:",
          terms: [
            "New clients only",
            "Pack of 3 Pilates classes",
            "All classes are at Wembley Fitness Gym",
            "You must contact us to book the remaining classes",
            "24 hour cancellation policy",
            "1 month expiration from the date of first class",
          ],
          actionUrl: "https://buy.stripe.com/fZu3cv1VA1AL5w32jHfMA02",
          dateLabel: "Date of first class:",
          price: 20,
        },
        "1-class": {
          title: "1 Class",
          subtitle:
            "Please fill in the form below and review the conditions at the bottom, before proceeding to payment.",
          termsHeading: "1 Class - Conditions:",
          terms: [
            //
            "Class is at Wembley Fitness Gym",
            "24 hour cancellation policy",
          ],
          actionUrl: "https://buy.stripe.com/14A5kDfMq2EP4rZ1fDfMA01",
          dateLabel: "Date of class:",
          price: 10,
        },
        "4-classes": {
          title: "4 Classes Pack",
          subtitle:
            "Please fill in the form below and review the conditions at the bottom, before proceeding to payment.",
          termsHeading: "4 Classes Pack - Conditions:",
          terms: [
            //
            "Pack of 4 Pilates classes",
            "All classes are at Wembley Fitness Gym",
            "You must contact us to book the remaining classes",
            "24 hour cancellation policy",
            "1 late cancellation",
            "2 months expiration from the date of first class",
          ],
          actionUrl: "https://buy.stripe.com/8x27sLcAefrB6A7gaxfMA03",
          dateLabel: "Date of first class:",
          price: 35,
        },
        "8-classes": {
          title: "8 Classes Pack",
          subtitle:
            "Please fill in the form below and review the conditions at the bottom, before proceeding to payment.",
          termsHeading: "8 Classes Pack - Conditions:",
          terms: [
            //
            "Pack of 8 Pilates classes",
            "All classes are at Wembley Fitness Gym",
            "You must contact us to book the remaining classes",
            "24 hour cancellation policy",
            "1 late cancellation",
            "3 months expiration from the date of first class",
          ],
          actionUrl: "https://buy.stripe.com/cNi4gzfMq6V54rZ7E1fMA04",
          dateLabel: "Date of first class:",
          price: 65,
        },
      };

      let currentPackId = "welcome-pack"; // Default pack

      // Function to parse URL parameters using URLSearchParams
      function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Function to format date asYYYY-MM-DD
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0"); // Months are 0-indexed
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // Function to get the day name (e.g., Thursday)
      function getDayName(date) {
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        return days[date.getDay()];
      }

      /**
       * Checks if a given date is within any of the unavailable date ranges.
       * Dates are compared by YYYY-MM-DD to ignore time components.
       * @param {Date} dateToCheck - The date to check for availability.
       * @param {Array<Object>} unavailableRanges - An array of objects, each with 'start' and/or 'end' properties (YYYY-MM-DD strings).
       * @returns {boolean} True if the date is unavailable, false otherwise.
       */
      function isDateUnavailable(dateToCheck, unavailableRanges) {
        const checkDate = new Date(dateToCheck.getFullYear(), dateToCheck.getMonth(), dateToCheck.getDate()); // Normalize to start of day

        for (const range of unavailableRanges) {
          let rangeStart = null;
          let rangeEnd = null;

          if (range.start) {
            const [y, m, d] = range.start.split("-").map(Number);
            rangeStart = new Date(y, m - 1, d); // Month is 0-indexed
          }
          if (range.end) {
            const [y, m, d] = range.end.split("-").map(Number);
            rangeEnd = new Date(y, m - 1, d); // Month is 0-indexed
          }

          // If it's a single date to skip
          if (rangeStart && !rangeEnd) {
            if (checkDate.getTime() === rangeStart.getTime()) {
              return true;
            }
          }
          // If it's a range
          else if (rangeStart && rangeEnd) {
            if (checkDate >= rangeStart && checkDate <= rangeEnd) {
              return true;
            }
          }
        }
        return false;
      }

      // Function to populate the date dropdown (Thurs, Fri, Sat for next 2 weeks, skipping unavailable dates)
      function populateDateDropdown() {
        const dateSelect = document.getElementById("submissionDate");
        const datesToInclude = [];
        const daysOfWeekToInclude = [4, 5, 6]; // Thursday (4), Friday (5), Saturday (6)
        const targetNumberOfDates = 6; // Aim for 2 weeks * 3 days/week
        const maxDaysToSearch = 60; // Prevent infinite loops, search up to ~2 months ahead

        let currentDate = new Date();
        currentDate.setDate(currentDate.getDate() + 1); // Start checking from tomorrow

        let daysChecked = 0;

        while (datesToInclude.length < targetNumberOfDates && daysChecked < maxDaysToSearch) {
          const dayOfWeek = currentDate.getDay();
          let time = "";

          // Assign time based on day of week
          if (dayOfWeek === 4) {
            // Thursday
            time = "17:00";
          } else if (dayOfWeek === 5) {
            // Friday
            time = "19:00";
          } else if (dayOfWeek === 6) {
            // Saturday
            time = "11:55";
          }

          // Check if it's a desired day of the week AND not unavailable
          if (daysOfWeekToInclude.includes(dayOfWeek) && !isDateUnavailable(currentDate, UNAVAILABLE_DATE_RANGES)) {
            // Store date and time together
            datesToInclude.push({ date: new Date(currentDate), time: time });
          }

          currentDate.setDate(currentDate.getDate() + 1); // Move to the next day
          daysChecked++;
        }

        // Clear existing options, ensuring the initial placeholder is correctly set as required
        dateSelect.innerHTML = '<option value="" disabled selected>Select a date</option>';

        // Add the generated dates to the dropdown
        if (datesToInclude.length === 0) {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "No available dates found for the next two weeks.";
          option.disabled = true;
          dateSelect.appendChild(option);
        } else {
          datesToInclude.forEach((item) => {
            const option = document.createElement("option");
            const formattedDate = formatDate(item.date);
            const dayName = getDayName(item.date);
            option.value = formattedDate; // Value is just the date (YYYY-MM-DD)
            option.textContent = `${dayName}, ${formattedDate} at ${item.time}`; // Display text with time
            dateSelect.appendChild(option);
          });
        }
      }

      // Function to populate the pack selection dropdown
      function populatePackSelectionDropdown() {
        const packSelect = document.getElementById("packSelection");
        packSelect.innerHTML = ""; // Clear existing options

        for (const packId in packs) {
          const option = document.createElement("option");
          option.value = packId;
          option.textContent = packs[packId].title;
          packSelect.appendChild(option);
        }

        // Set the default selected pack based on currentPackId
        packSelect.value = currentPackId;
      }

      // Function to render the form content based on the selected pack
      function renderPackContent(packId) {
        const packData = packs[packId];
        if (!packData) {
          console.error("Pack not found:", packId);
          return;
        }

        // Update page title
        document.getElementById("pageTitle").textContent = `Buy ${packData.title} - Pilates with Filomena`;
        // Update form title
        document.getElementById("formTitle").textContent = `Buy ${packData.title}`;
        // Update subtitle
        document.getElementById("formSubtitle").textContent = packData.subtitle;
        // Update terms heading
        document.getElementById("termsHeading").textContent = packData.termsHeading;

        // Update terms list
        const termsList = document.getElementById("termsList");
        termsList.innerHTML = ""; // Clear existing terms
        packData.terms.forEach((term) => {
          const li = document.createElement("li");
          li.textContent = term;
          termsList.appendChild(li);
        });

        // Update "Date of class" label
        document.getElementById("submissionDateLabel").textContent = packData.dateLabel;

        // Update submit button text
        document.getElementById("submitButton").textContent = `Pay £${packData.price}`;

        currentPackId = packId; // Update the current pack ID
        // Ensure the dropdown reflects the currently rendered pack
        document.getElementById("packSelection").value = currentPackId;

        // Re-populate date dropdown when pack changes, as unavailable dates might differ
        populateDateDropdown();
      }

      // Event listener for pack selection change
      document.getElementById("packSelection").addEventListener("change", function () {
        renderPackContent(this.value);
      });

      // Handle form submission
      document.getElementById("submissionForm").addEventListener("submit", function (event) {
        // Always prevent default submission to handle redirection via JavaScript
        event.preventDefault();

        const nameInput = document.getElementById("name");
        const emailInput = document.getElementById("email");
        const submissionDateSelect = document.getElementById("submissionDate");

        const name = nameInput.value;
        const email = emailInput.value;
        const submissionDateValue = submissionDateSelect.value; // This is YYYY-MM-DD

        // Perform custom validation for the date selection
        // Clear any previous custom validity message
        submissionDateSelect.setCustomValidity("");

        let isValid = true; // Flag to track overall form validity

        // Validate name field
        if (!nameInput.checkValidity()) {
          isValid = false;
        }

        // Validate email
        if (!emailInput.checkValidity()) {
          isValid = false;
        }

        // Validate submission date
        if (submissionDateValue === "") {
          isValid = false; // Mark as invalid if date is not selected
        } else {
          const selectedDate = new Date(submissionDateValue);
          const dayOfWeek = selectedDate.getDay();
          const daysOfWeekToInclude = [4, 5, 6];

          if (!daysOfWeekToInclude.includes(dayOfWeek) || isDateUnavailable(selectedDate, UNAVAILABLE_DATE_RANGES)) {
            submissionDateSelect.setCustomValidity(
              "Please select an available date (Thursday, Friday, or Saturday) that is not marked as unavailable."
            );
            isValid = false; // Mark as invalid if custom date validation fails
          }
        }

        // If any validation failed, report validity and stop
        if (!isValid) {
          // This will trigger native validation messages for all invalid fields
          nameInput.reportValidity();
          emailInput.reportValidity();
          submissionDateSelect.reportValidity();
          return;
        }

        // If all validations pass, proceed with redirection
        const selectedPackData = packs[currentPackId];
        const baseUrl = selectedPackData.actionUrl;

        // date (without time) and name
        let clientReferenceId = `${submissionDateValue}_${name}`;

        // Restrict to alphanumeric characters
        clientReferenceId = clientReferenceId.replace(/\W+/g, "_").replace(/[^a-zA-Z0-9-_]/g, "");

        // Truncate to a maximum of 200 characters
        if (clientReferenceId.length > 200) {
          clientReferenceId = clientReferenceId.substring(0, 200);
        }

        // Encode parameters for URL
        const encodedEmail = encodeURIComponent(email);
        const encodedClientReferenceId = encodeURIComponent(clientReferenceId);

        // Construct the new URL with only the desired parameters
        const targetUrl = `${baseUrl}?prefilled_email=${encodedEmail}&client_reference_id=${encodedClientReferenceId}`;

        // Redirect the browser
        window.location.href = targetUrl;
      });

      // Event listener for date selection change to provide immediate feedback
      document.getElementById("submissionDate").addEventListener("change", function () {
        const submissionDateSelect = this;
        const submissionDateValue = submissionDateSelect.value;

        // Always clear previous custom validity first
        submissionDateSelect.setCustomValidity("");

        if (submissionDateValue !== "") {
          const selectedDate = new Date(submissionDateValue);
          const dayOfWeek = selectedDate.getDay();
          const daysOfWeekToInclude = [4, 5, 6];

          if (!daysOfWeekToInclude.includes(dayOfWeek) || isDateUnavailable(selectedDate, UNAVAILABLE_DATE_RANGES)) {
            submissionDateSelect.setCustomValidity(
              "Please select an available date (Thursday, Friday, or Saturday) that is not marked as unavailable."
            );
          }
        }
        // reportValidity will show the message if invalid, or clear it if valid
        submissionDateSelect.reportValidity();
      });

      // Initialize the page on load
      window.addEventListener("load", function () {
        // Check for URL parameter first
        const urlPackOption = getUrlParameter("option");
        if (urlPackOption && packs[urlPackOption]) {
          currentPackId = urlPackOption;
        }

        populatePackSelectionDropdown(); // Populate the pack dropdown first
        renderPackContent(currentPackId); // Render content for the determined pack (this will call populateDateDropdown)
      });
    </script>
  </body>
</html>
